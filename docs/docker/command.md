# Docker 명령어

## Container 명령어

컨테이너를 실행하거나 종료하고, 컨테이너 목록을 확인하는 등 컨테이너를 다루기 위해 사용하는 명령어다.
컨테이너를 대상으로 어떤 일을 할지는 하위 명령어를 통해 지정한다.

```{.sh .no-copy}
$ docker container <하위 명령어> [옵션]
```

### 주요 하위 명령어

| 하위 명령어 | 내용                                                                                                                                                                                                 | 생략가능 | 주요 옵션                |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: | ------------------------ |
| start       | 컨테이너를 실행                                                                                                                                                                                      |    O     | -i                       |
| stop        | 컨테이너를 정지                                                                                                                                                                                      |    O     |                          |
| create      | 도커 이미지로부터 컨테이너를 생성                                                                                                                                                                    |    O     | --name -e -p -v          |
| run         | 도커 이미지를 내려받고 컨테이너를 생성해 실행함(다운로드는 필요한 경우에만).<br />`docker image pull`, `docker container create`, `docker container start`라는 세 개의 명령을 하나로 합친 것과 같다. |    O     | --name -e -p -v -d -i -t |
| rm          | 정지 상태의 컨테이너를 삭제                                                                                                                                                                          |    O     | -f -v                    |
| exec        | 실행 중인 컨테이너 속에서 프로그램을 실행                                                                                                                                                            |    O     | -i -t                    |
| ls          | 컨테이너 목록을 출력                                                                                                                                                                                 |  O[^1]   | -a                       |
| cp          | 도커 컨테이너와 도커 호스트 간에 파일을 복사                                                                                                                                                         |    O     |                          |
| commit      | 도커 컨테이너를 이미지로 변환                                                                                                                                                                        |    O     |                          |

[^1]: 생략형은 `docker ps`

## Image 명령어

이미지를 내려받거나 검색하는 등 이미지와 관련된 기능을 실행하는 명령어다.
이미지를 대상으로 어떤 일을 할지는 하위 명령어를 통해 지정한다.

```{.cp .no-copy}
$ docker image <하위 명령어> [옵션]
```

### 주요 하위 명령어

| 하위 명령어 | 내용                                            | 생략가능 | 주요 옵션 |
| ----------- | ----------------------------------------------- | :------: | --------- |
| pull        | 도커 허브 등의 리포지토리에서 이미지를 내려받음 |    O     |           |
| rm          | 도커 이미지를 삭제                              |  O[^2]   |           |
| ls          | 내려받은 이미지의 목록을 출력                   |    X     |           |
| build       | 도커 이미지를 생성                              |    O     | -t        |

[^2]: 생략형은 `docker rmi`

## Volumn 명령어

볼륨 생성, 목록 확인, 삭제 등 볼륨(컨테이너에 마운트 가능한 스토리지)과 관련된 기능을 실행하는 명령어다.
볼륨을 대상으로 어떤 일을 할지는 하위 명령어를 통해 지정한다.

```{.sh .no-copy}
$ docker volumn <하위 명령어> [옵션]
```

### 주요 하위 명령어

| 하위 명령어 | 내용                                  | 생략가능 | 주요 옵션 |
| ----------- | ------------------------------------- | :------: | --------- |
| create      | 볼륨을 생성                           |    X     | --name    |
| inspect     | 볼륨의 상세 정보를 출력               |    X     |           |
| ls          | 볼륨의 목록을 출력                    |    X     | -a        |
| prune       | 현재 마운트되지 않은 볼륨을 모두 삭제 |    X     |           |
| rm          | 지정된 볼륨을 삭제                    |    X     |           |

## Network 명령어

도커 네트워크의 생성, 삭제, 컨테이너의 네트워크 접속 및 접속 해제 등 도커 네트워크와 관련된 기능을 실행하는 명령어다.
도커 네트워크란 도커 요소 간의 통신에 사용하는 가상 네트워크를 가리킨다.

```{.sh .no-copy}
$ docker network <하위 명령어> [옵션]
```

### 주요 하위 명령어

| 하위 명령어 | 내용                                               | 생략가능 | 주요 옵션 |
| ----------- | -------------------------------------------------- | :------: | --------- |
| connect     | 컨테이너를 도커 네트워크에 연결                    |    X     |           |
| disconnect  | 컨테이너의 도커 네트워크 연결을 해제               |    X     |           |
| create      | 도커 네트워크를 생성                               |    X     |           |
| inspect     | 도커 네트워크의 상세 정보를 출력                   |    X     |           |
| ls          | 도커 네트워크의 목록을 출력                        |    X     |           |
| prune       | 현재 컨테이너가 접속하지 않은 네트워크를 모두 삭제 |    X     |           |
| rm          | 지정한 네트워크를 삭제                             |    X     |           |

## 그 밖의 상위 명령어

이 밖에도 다음과 같은 상위 명령어가 있다.
하지만 이들 중 대부분은 도커 스웜<sup>Docker Swam[^3]</sup>과 관련된 명령어로서 *초보자 수준에서는 사용할 일이 아직 없다.*
숙련자 수준이 된 이후에 필요에 맞게 확인하자.

| 상위 명령어 | 내용                                                                                              |
| ----------- | ------------------------------------------------------------------------------------------------- |
| checkpoint  | 현재 상태를 일시적으로 저장한 후, 나중에 해당 시점의 상태로 되돌릴 수 있다. 현재 실험적 기능이다. |
| node        | 도커 스웜의 노드를 관리하는 기능                                                                  |
| plugin      | 플러그인을 관리하는 기능                                                                          |
| secret      | 도커 스웜의 비밀값 정보를 관리하는 기능                                                           |
| service     | 도커 스웜의 서비스를 관리하는 기능                                                                |
| stack       | 도커 스웜 또는 쿠버네티스에서 여러 개의 서비스를 합쳐 구성한 스택을 관리하는 기능                 |
| swarm       | 도커 스웜을 관리하는 기능                                                                         |
| system      | 도커 엔진의 정보를 확인하는 기능                                                                  |

## 단독으로 사용되는 명령어

상위 명령어 없이 단독으로 쓰이는 특수한 명령어가 네 가지 있다.
주로 도커 허브의 검색이나 로그인에 사용되는 명령어다.

| 단독 명령어 | 내용                                   | 주요 옵션 |
| ----------- | -------------------------------------- | --------- |
| login       | 도커 레지스트리에 로그인               | -u -p     |
| logout      | 도커 레지스트리에 로그아웃             |           |
| search      | 도커 레지스트리를 검색                 |           |
| version     | 도커 엔진 및 명령행 도구의 버전을 출력 |           |

[^3]: 컨테이너 오케스트레이션 기능을 제공한다. 쿠버네티스와는 별개의 도구이다.

## `Dockerfile` 스크립트 인스트럭션

| 인스트럭션  | 내용                                                                                       |
| ----------- | ------------------------------------------------------------------------------------------ |
| FROM        | 토대가 되는 이미지를 지정                                                                  |
| ADD         | 이미지에 파일이나 폴더를 추가                                                              |
| COPY        | 이미지에 파일이나 폴더를 추가                                                              |
| RUN         | 이미지를 빌드할 때 실행할 명령어를 지정                                                    |
| CMD         | 컨테이너를 실행할 때 실행할 명령어를 지정                                                  |
| ENTRYPOINT  | 컨테이너를 실행할 때 실행할 명령어를 강제 지정                                             |
| ONBUILD     | 이 이미지를 기반으로 다른 이미지를 빌드할 때 실행할 명령어를 지정                          |
| EXPOSE      | 이미지가 통신에 사용할 포트를 명시적으로 지정                                              |
| VOLUME      | 퍼시스턴시 데이터를 저장할 경로를 명시적으로 지정                                          |
| ENV         | 환경변수를 정의                                                                            |
| WORKDIR     | RUN, CMD, ENTRYPOINT, ADD, COPY에 정의된 명령어를 실행하는 작업 디렉토리를 지정            |
| SHELL       | 빌드 시 사용할 셀을 변경                                                                   |
| LABEL       | 이름이나 버전, 저작자 정보를 설정                                                          |
| USER        | RUN, CMD, ENTRYPOINT에 정의된 명령어를 실행하는 사용자 또는 그룹을 지정                    |
| ARG         | docker build 명령어를 사용할 때 입력받을 수 있는 인자를 선언                               |
| STOPSIGNAL  | docker stop 명령어를 사용할 때 컨테이너 안에서 실행 중인 프로그램에 전달되는 시그널을 변경 |
| HEALTHCHECK | 컨테이너 헬스체크 방법을 커스터마이징                                                      |

## Docker Compose

### YAML 파일

#### 주 항목

| 항목     | 내용                 |
| -------- | -------------------- |
| services | 컨테이너를 정의한다. |
| networks | 네트워크를 정의한다. |
| volumes  | 볼륨을 정의한다.     |

#### 자주 나오는 정의 내용

| 항목        | docker run 명령어의 옵션 또는 인자 | 내용                                                                                      |
| ----------- | ---------------------------------- | ----------------------------------------------------------------------------------------- |
| image       | <이미지 인자>                      | 사용할 이미지를 지정                                                                      |
| networks    | --net                              | 접속할 네트워크를 지정                                                                    |
| volumes     | -v, --mount                        | 스토리지 마운트를 설정                                                                    |
| ports       | -p                                 | 포트 설정                                                                                 |
| environment | -e                                 | 환경변수 설정                                                                             |
| depends_on  |                                    | 다른 서비스에 대한 의존관계를 정의                                                        |
| restart     |                                    | 컨테이너 종료 시 재시작 여부를 설정<br />(`no`, `always`, `on-failure`, `unless-stopped`) |

#### 그 외 정의 항목

| 항목           | docker run 명령어의 옵션 또는 인자 | 내용                                          |
| -------------- | ---------------------------------- | --------------------------------------------- |
| command        | <명령어 인자>                      | 컨테이너 시작 시 기존 명령어를 오버라이드     |
| container_name | --name                             | 실행할 컨테이너의 이름을 명시적으로 지정      |
| dns            | --dns                              | DNS 서버를 명시적으로 지정                    |
| env_file       |                                    | 환경설정 정보를 기재한 파일을 로드            |
| entrypoint     | --entrypoint                       | 컨테이너 시작 시 ENTRYPOINT 설정을 오버라이드 |
| external_links | --link                             | 외부 링크를 설정                              |
| extra_hosts    | --add-host                         | 외부 호스트의 IP 주소를 명시적으로 지정       |
| logging        | --log-driver                       | 로그 출력 대상을 설정                         |
| network_mode   | --network                          | 네트워크 모드를 설정                          |

### `docker-compose up` 명령어

```{.sh .no-copy}
docker-compose [-f <정의 파일>] up [옵션]
```

| 옵션                      | 내용                                                   |
| ------------------------- | ------------------------------------------------------ |
| -d                        | 백그라운드 실행                                        |
| --no-color                | 화면 출력 내용을 흑백으로 함                           |
| --no-deps                 | 링크된 서비스를 실행하지 않음                          |
| --force-recreate          | 설정 또는 이미지가 변경되지 않더라도 컨테이너를 재생성 |
| --no-create               | 컨테이너가 이미 존재할 경우 다시 생성하지 않음         |
| --no-build                | 이미지가 없어도 이미지를 빌드하지 않음                 |
| --build                   | 컨테이너를 실행하기 전에 이미지를 빌드                 |
| --abort-on-container-exit | 컨테이너가 하나라도 종료되면 모든 컨테이너를 종료      |
| -t, --timeout             | 컨테이너를 종료할 때의 타임아웃 설정. 기본 10초        |
| --remove-orphans          | 컴포즈 파일에 정의되지 않은 서비스의 컨테이너를 삭제   |
| --scale                   | 컨테이너의 수를 변경                                   |

### `docker-compose down` 명령어

```{.sh .no-copy}
docker-compose [-f <정의 파일>] down [옵션]
```

| 옵션             | 내용                                                                                                                                             |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| --rmi <종류>     | 삭제 시에 이미지도 삭제한다. <종류>를 `all`로 지정하면 사용했던 모든 이미지가 삭제된다. `local`로 지정하면 커스텀 태그가 없는 이미지만 삭제한다. |
| -v, --volumes    | volumes 항목에 기재된 볼륨을 삭제한다. 단 `external`로 지정된 볼륨은 삭제되지 않는다.                                                            |
| --remove-orphans | 컴포즈 파일에 정의되지 않은 서비스의 컨테이너도 삭제한다.                                                                                        |

### `docker-compose stop` 명령어

```{.sh .no-copy}
docker-compose [-f <정의 파일>] stop [옵션]
```




## Tips

### 이미지를 옮기는 방법

컨테이너는 먼저 이미지로 변환하지 않으면 옮기거나 복사할 수 없다. 
하지만 이미지 역시 이미지 상태 그대로는 옮기거나 복사할 수 없으므로 도커 레지스트리를 통하거나 `save` 명령어를 사용해 tar 포맷으로 도커 엔진의 관리 영역 밖으로 내보내야 한다.
파일은 호스트 컴퓨터의 파일 시스템에 생성된다. 
파일을 다시 도커 엔진에 가져오려면 `load` 명령어를 사용한다.

**tar 파일 생성**

```{.sh .no-copy}
docker save -o <파일이름.tar> <이미지 이름>
```

### 실행 중인 컨테이너 한 번에 종료하기

```sh
docker rm -f $(docker ps -qa)
```

### 등록된 모든 이미지를 한 번에 삭제하기

```sh
docker rmi $(docker images -q)
```

또는

```sh
docker image rm -f $(docker images -q)
```

### `prune`으로 사용하지 않는 오브젝트만 삭제하기

다음 명령어는 중지된 컨테이너를 삭제한다.

```sh
docker container prune
```

다음 명령어는 dangling 상태의 이미지를 삭제한다. dangling 이미지는 이미지 목록에서 태그가 없이 `<none>`으로 보이는 이미지이다.

```sh
docker image prune
```

`-a` 옵션을 사용하면, dangling 이미지와 컨테이너에서 사용되지 않는 이미지를 모두 삭제한다.

```sh
docker image prune -a
```

`system prune` 명령어를 사용하면 중지된 컨테이너, dangling 이미지, 사용하지 않는 볼륨, 사용하지 않는 네트워크를 한꺼번에 삭제한다.
사용하지 않는 이미지도 함께 삭제하려면 `-a` 옵션을 사용한다.

```sh
docker system prune
```
